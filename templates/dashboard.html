{% extends 'base.html' %}

{% block title %}Dash{% endblock %}

{% block extra_head %}
<link href="/static/css/dash.css" rel="stylesheet">
<meta name="csrf-token" content="{% csrf_token %}">{% endblock %}

{% block content %}

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/showdown.min.js"></script>
<script src="/static/js/github.js"></script>
<script src = "/static/js/tether.min.js"></script>

<script>
  function textToImage(contentType, content, replaceId) {
    var image = new Image();
    image.src = "data:" + contentType + "," + content;
    document.getElementById(replaceId).replaceWith(image);
  }
</script>

<template id="git_template">
  <div class='post git'>
    <p class='title'>test</p>
    <p class='description'><p/>
    <p class='content'><p/>
    By <a href="{{user.author.github}}" class='creator' target="_blank"></a> on <span class='creation_date'></span>
  </div>
</template>

<button type="button" class="btn btn-default btn-block" data-toggle="modal" data-target="#post_form">New Post</button>

<div id="post_form" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <form method="POST" action="{% url 'dash:newpost' %}" enctype="multipart/form-data">
          {% csrf_token %}
          {{ postForm }}
          <input type="submit" value='Post' class="btn btn-success btn-sm"/>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
$(".private").hide();
$('label[for="unlisted"]').hide();
$("#visibility").change(function (){
    if ($(this).val() == 'PRIVATE') {
      $(".private").show();
      $('label[for="unlisted"]').show();
    }
    else {
      $(".private").hide();
      $('label[for="unlisted"]').hide();
    }
});
</script>

<script>
  function friendRequest(author_id) {
    $.ajax({
        url: "{% url 'dash:sendfriendrequest' %}",
        type: 'POST',
        data: {
          id:author_id,
          _token: $('meta[name="csrf-token"]').attr('content')
        },
        success: function(result) {
          location.reload();
        }
    });
  }
</script>

<div id='stream'>
{% if latest_post_list %}
  {% for post in latest_post_list %}
      <div class="post">
        <div class="content">
          <a class="post_link" href="{{post.id}}"><h2 class='title'>{{post.title}}</h2></a>
          <h4 class='description'>{{post.description}}</h4>
          <h4>
          {% for category in post.category_set.all %}
            <span>{{category.category}}</span>
          {% endfor %}
          </h4>
          {% if 'base64' not in post.contentType %}
            <div class='{{post.contentType}}'>{{post.content}}</div>
          {% else %}
            <div id="post_{{post.id|slugify}}"></div>
            <script>
              textToImage('{{post.contentType}}', '{{post.content}}', "post_{{post.id|slugify}}")
            </script>
          {% endif %}
          {% if post.author.url != user.author.url %}
          <div id="author_of_post_{{post.id|slugify}}" class="modal fade" role="dialog">
            <div class="modal-dialog modal-sm">
              <div class="modal-content">
                
                <div class="modal-header">
                  Add {{post.author.displayName}} as a friend?
                </div>
                <div class="modal-header">
                  <form method="POST" action="{% url 'dash:sendfriendrequest' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="author" value='{{post.author.url}}'>
                    <input type="submit"  class="btn btn-success btn-sm" value="Send">
                  </form>
                </div>
                
              </div>
            </div>
          </div>
          {% endif %}
          <p>Created by
            <a href="#" data-toggle="modal" data-target="#author_of_post_{{post.id|slugify}}">{{post.author.displayName}}</a>
            on {{post.published}}</p>
        </div>
        <div class="comment_section">
          {% with post.id|slugify as p_id%}
          <h4 class='title'>
            {{post.comments|length}} comment{% if post.comments|length != 1 %}s{% endif %}
            <span id="btn_{{p_id}}" class="glyphicon glyphicon-edit"></span>
          </h4>
          <form id='form_{{p_id}}' method="POST" action="{% url 'dash:newcomment' %}">
            {% csrf_token %}
            {{ commentForm }}
            <input type='hidden' name='post_id' value={{post.id}}>
            <input type="submit" value='Comment' class="btn btn-success btn-sm"/>
          </form>
          <script>
            $("#form_{{p_id}}").hide();
            $(document).ready(function(){
                $("#btn_{{p_id}}").click(function(){
                    $("#form_{{p_id}}").slideToggle();
                });
            });
          </script>
          {% endwith %}
          <div class="comments">
            {% for comment in post.comments %}
              <div class="comment">
                <a class="author" href="{{comment.author.url}}">{{comment.author.displayName}}</a> <span class="date">{{comment.published}}</span>
                <div class='content {{comment.contentType}}'>{{comment.comment}}</div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
  {% endfor %}
{% else %}
  <p>No posts available.</p>
{% endif %}
</div>

<div id='git_stream'>
  <h4>Github Activity</h4>
  <div id='git_events' class="pre-scrollable">
  </div>
  <button type="button" id='git_button' class="btn btn-default btn-block" onclick="loadPage('{{user.author.github}}')">Load More</button>
</div>

<script>loadPage("{{user.author.github}}")</script>


<script>
  var markdownText = document.getElementsByClassName('text/markdown');
  for (var i = 0; i < markdownText.length; ++i) {
    var item = markdownText[i];
    var converter = new showdown.Converter();
    var html = converter.makeHtml(item.innerHTML);
    item.innerHTML = html;
  }
</script>

<script>
  var postLinks = document.getElementsByClassName('post_link');
  for (var i = 0; i < postLinks.length; ++i) {
    var link = postLinks[i];
    link.href = link.href.replace("posts","dash/posts");
  }
</script>


{% endblock %}
