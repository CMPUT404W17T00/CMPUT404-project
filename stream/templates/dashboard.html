{% extends 'base.html' %}

{% block content %}

<template id="git_template">
  <div class='post git'>
    <h5 class='title'>test</h2>
    <p class='description'><p/>
    <p class='content'><p/>
    <p class='creator'></p>
  </div>
</template>

<!-- This is the real form starter, only doable after we have a rest api
set up. Make sure to add the missing % sign for Jinja templating, had to remove
it to make sure this form would render during testing -->
<!--<form method="POST" action="{ url 'rest:postPOST' %}">-->
<form method="POST" action="https://webdocs.cs.ualberta.ca/~hindle1/1.py">
  <!-- See dash.models for these fields in order -->

  <!-- Start fields relevant to text content of post -->
  <div>
    <input type="text" name="title" maxlength="32" placeholder="Title"/><br/>
    <input type="text" name="description" maxlength="140" placeholder="Description"/><br/>
    <!-- This is just placeholder until we can do markup-->
    <input type="hidden" name="contentType" value="text/plain"/><br/>
    <textarea name="content" rows="15" cols="50"></textarea><br/>
    <input type="text" name="categories" maxlength="128" placeholder="Categories, comma separated"/><br/>
  </div>
  <!-- Start fields relevant to options -->
  <div>
    <select name="visibility">
      <option selected value="PUBLIC">Public</option>
      <option value="FOAF">Friends of Friends</option>
      <option value="FRIENDS">Friends</option>
      <option value="SERVERONLY">Server Only</option>
      <option value="PRIVATE">Private</option>
    </select> <br/>
    <input disabled type="text" name="visibleTo" placeholder="Visible to while private"/>
  </div>

  <input type="submit"/>
</form>


<div id='stream'>
{% if latest_post_list %}
  {% for post in latest_post_list %}
      <div class="post">
        <div class="content">
          <h2>{{post.title}}</h2>
          <p>{{post.description}}<p/>
          <p>{{post.content}}<p/>
          <p>Created by {{post.author}} on {{post.published.date}}</p>
        </div>
        <div class="comment_section">
          <h3>Comments</h3>
          <form method="POST" action="https://webdocs.cs.ualberta.ca/~hindle1/1.py">
            <textarea name="comment" cols="50"></textarea><br/>
            <input type="hidden" name="contentType" value="text/plain"/><br/>
            <input type="submit"/>
          </form>
          {% for comment in post.comment_set.all %}
            <div class="comment">
              {{ comment.comment }}<br/>
              Created by {{comment.author}} on {{comment.published.date}}<br/><br/>
            </div>
          {% endfor %}
        </div>
      </div>
  {% endfor %}
{% else %}
  <p>No posts available.</p>
{% endif %}
</div>

<div id='git_stream'>
</div>


<script>
function sendJSONXMLHTTPRequest(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
        if (xhr.readyState==4) {
            try {
                if (xhr.status==200) {
                  var parsed = JSON.parse(xhr.responseText);
                  //var parsed = xhr.responseText;
                  callback(parsed);
                }
            }
            catch(e) {
                alert('Error: ' + e.name);
            }
        }
    };
    xhr.open("GET",url);
    //xhr.setRequestHeader("Content-Type","application/json");
    xhr.setRequestHeader("Accept","application/json");
    xhr.send(null);
}

sendJSONXMLHTTPRequest('https://api.github.com/users/nshillin/events/public', function (parsedText) {
  var template = document.getElementById("git_template");
  var stream = document.getElementById('git_stream');
  for (var i = 0; i < parsedText.length; i++) {
    var newGit = template.content.cloneNode(true).childNodes[1];
    newGit.getElementsByClassName('title')[0].innerHTML = parsedText[i].repo.name + ': ' + parsedText[i].type
    newGit.getElementsByClassName('creator')[0].innerHTML = 'By ' + parsedText[i].actor.display_login + ' on ' + parsedText[i].created_at
    stream.insertBefore(newGit,stream.childNodes[0]);
  }
})

</script>

{% endblock %}
